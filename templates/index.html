<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swimfinder</title>
  <style>
    /* ‚îÄ‚îÄ‚îÄ Design tokens ‚îÄ‚îÄ‚îÄ */
    :root {
      --bg:           #eef2f9;
      --surface:      #ffffff;
      --surface-2:    #f5f8fc;
      --border:       #e2e8f0;
      --border-2:     #cdd5e0;
      --text-1:       #0f172a;
      --text-2:       #475569;
      --text-3:       #94a3b8;
      --blue:         #1d4ed8;
      --blue-pale:    #dbeafe;
      --green:        #059669;
      --green-pale:   #d1fae5;
      --amber:        #b45309;
      --amber-pale:   #fef3c7;
      --red:          #dc2626;
      --red-pale:     #fee2e2;
      --r-lg:         14px;
      --r:            10px;
      --r-sm:         7px;
      --shadow-sm:    0 1px 2px rgba(15,23,42,.06), 0 1px 3px rgba(15,23,42,.04);
      --shadow:       0 4px 12px rgba(15,23,42,.08), 0 2px 4px rgba(15,23,42,.04);
      --font:         -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text-1);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ Skip link (keyboard a11y) ‚îÄ‚îÄ‚îÄ */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 1rem;
      padding: 0.5rem 1rem;
      background: var(--blue);
      color: #fff;
      border-radius: 0 0 var(--r-sm) var(--r-sm);
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      z-index: 100;
      transition: top 0.15s;
    }
    .skip-link:focus { top: 0; outline: 2px solid #fff; outline-offset: 2px; }

    /* ‚îÄ‚îÄ‚îÄ App bar (sticky) ‚îÄ‚îÄ‚îÄ */
    .app-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.85rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: var(--shadow-sm);
    }
    .app-bar-inner {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .app-title {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .app-title-icon { font-size: 1.2rem; line-height: 1; }
    .app-title h1 {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--blue);
      letter-spacing: -0.02em;
      white-space: nowrap;
    }

    /* Date navigation */
    .date-nav {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-left: auto;
      flex-wrap: wrap;
    }
    #date-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-1);
      min-width: 15rem;
      text-align: center;
    }

    /* Shared button base */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      background: var(--surface);
      cursor: pointer;
      color: var(--text-2);
      font-family: inherit;
      font-size: 0.85rem;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
      white-space: nowrap;
    }
    .btn:hover        { background: var(--blue-pale); border-color: #93c5fd; color: var(--blue); }
    .btn:focus-visible { outline: 2px solid var(--blue); outline-offset: 2px; }

    .btn-icon { width: 34px; height: 34px; border-radius: var(--r-sm); font-size: 1rem; }
    .btn-text { height: 34px; padding: 0 0.85rem; border-radius: var(--r-sm); font-weight: 600; }

    /* ‚îÄ‚îÄ‚îÄ Main content ‚îÄ‚îÄ‚îÄ */
    .main {
      max-width: 1000px;
      margin: 1.25rem auto;
      padding: 0 1rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    /* ‚îÄ‚îÄ‚îÄ Now bar ‚îÄ‚îÄ‚îÄ */
    .now-bar {
      border-radius: var(--r);
      padding: 0.75rem 1.1rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      line-height: 1.4;
    }
    .now-bar-active { background: var(--green-pale); color: #064e3b; border: 1px solid #6ee7b7; }
    .now-bar-idle   { background: var(--surface);    color: var(--text-2); border: 1px solid var(--border); }

    .now-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .now-bar-active .now-dot {
      background: var(--green);
      animation: pulse-dot 2s ease-in-out infinite;
    }
    .now-bar-idle .now-dot { background: var(--text-3); }

    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 3px #a7f3d0; }
      50%       { box-shadow: 0 0 0 6px #d1fae5; }
    }

    .now-pool-tag { font-weight: 700; }
    .now-until    { opacity: 0.85; }
    .now-sep      { opacity: 0.35; }
    .now-next     { font-style: italic; opacity: 0.8; }

    /* ‚îÄ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ‚îÄ */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .filter-label {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }
    .filter-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.28rem 0.75rem;
      border-radius: 99px;
      border: 2px solid;
      background: var(--surface);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.78rem;
      font-weight: 700;
      transition: opacity 0.15s, box-shadow 0.15s;
      box-shadow: var(--shadow-sm);
    }
    .filter-btn:hover       { box-shadow: var(--shadow); }
    .filter-btn:focus-visible { outline: 2px solid var(--blue); outline-offset: 2px; }
    .filter-btn .swatch     { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .filter-btn.off         { opacity: 0.3; box-shadow: none; text-decoration: line-through; }

    /* ‚îÄ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ‚îÄ */
    .cal-wrap {
      background: var(--surface);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow);
      overflow-x: auto;               /* horizontal scroll on small screens */
      border: 1px solid var(--border);
    }
    .cal-inner  { min-width: 420px; } /* prevent columns collapsing too narrow */

    .cal-headers { display: flex; border-bottom: 2px solid var(--border-2); }
    .cal-gutter-head { flex-shrink: 0; background: var(--surface-2); }
    .cal-col-head {
      flex: 1;
      padding: 0.7rem 0.5rem 0.6rem;
      text-align: center;
      border-left: 1px solid var(--border);
      background: var(--surface-2);
      min-width: 0;
    }
    .cal-col-head a {
      font-size: 0.82rem;
      font-weight: 700;
      text-decoration: none;
      display: block;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cal-col-head a:hover { text-decoration: underline; }

    .cal-body { display: flex; }
    .cal-time-col {
      flex-shrink: 0;
      position: relative;
      background: var(--surface-2);
      border-right: 1px solid var(--border-2);
    }
    .cal-hour-label {
      position: absolute;
      right: 8px;
      font-size: 0.61rem;
      font-weight: 600;
      color: var(--text-3);
      transform: translateY(-50%);
      user-select: none;
      letter-spacing: 0.02em;
    }

    .cal-pools    { flex: 1; display: flex; position: relative; }
    .cal-pool-col { flex: 1; position: relative; border-left: 1px solid var(--border); min-width: 0; }

    .cal-hline { position: absolute; left: 0; right: 0; pointer-events: none; }
    .cal-hline.full { border-top: 1px solid #edf1f7; }
    .cal-hline.half { border-top: 1px dashed #f3f6fa;  }

    .cal-slot {
      position: absolute;
      left: 3px; right: 3px;
      border-radius: 6px;
      color: #fff;
      font-size: 0.67rem;
      padding: 4px 6px;
      overflow: hidden;
      cursor: default;
      transition: filter 0.12s, box-shadow 0.12s;
      box-shadow: 0 1px 3px rgba(0,0,0,.20), 0 1px 2px rgba(0,0,0,.10);
    }
    .cal-slot:hover {
      filter: brightness(1.1);
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      z-index: 2;
    }
    .cal-slot .sl-time { font-weight: 700; white-space: nowrap; display: block; }
    .cal-slot .sl-dur  { opacity: 0.82; font-size: 0.61rem; display: block; margin-top: 1px; }
    .cal-slot.fallback { opacity: 0.65; }

    /* Current-time red line */
    .cal-now {
      position: absolute;
      left: 0; right: 0;
      pointer-events: none;
      z-index: 5;
    }
    .cal-now::after {
      content: "";
      display: block;
      border-top: 2px solid var(--red);
    }
    .cal-now::before {
      content: "";
      position: absolute;
      left: 0; top: -3px;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--red);
    }

    /* ‚îÄ‚îÄ‚îÄ Badges ‚îÄ‚îÄ‚îÄ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 0.6rem;
      font-weight: 700;
      padding: 0.13rem 0.42rem;
      border-radius: 99px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      white-space: nowrap;
    }
    .badge::before {
      content: "";
      width: 5px; height: 5px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .badge-live        { background: var(--green-pale); color: #065f46; }
    .badge-live::before        { background: var(--green); }
    .badge-fallback    { background: var(--amber-pale); color: #78350f; }
    .badge-fallback::before    { background: var(--amber); }
    .badge-unavailable { background: var(--red-pale);   color: #7f1d1d; }
    .badge-unavailable::before { background: var(--red); }

    /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
    #cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.75rem;
    }
    .card {
      background: var(--surface);
      border-radius: var(--r);
      box-shadow: var(--shadow-sm);
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border: 1px solid var(--border);
      border-left: 3px solid transparent;
    }
    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .card-header a {
      font-size: 0.88rem;
      font-weight: 700;
      text-decoration: none;
    }
    .card-header a:hover { text-decoration: underline; }

    .slots { list-style: none; display: flex; flex-direction: column; gap: 0.2rem; }
    .slots li {
      font-size: 0.83rem;
      font-variant-numeric: tabular-nums;
      color: var(--text-2);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .slot-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.4;
      flex-shrink: 0;
    }
    .no-slots { font-size: 0.81rem; color: var(--text-3); font-style: italic; }

    /* ‚îÄ‚îÄ‚îÄ Loading / error ‚îÄ‚îÄ‚îÄ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      padding: 4rem 2rem;
      color: var(--text-3);
      font-size: 0.9rem;
    }
    .spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border-2);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { text-align: center; color: var(--red); font-size: 0.9rem; padding: 2rem; }

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .app-bar { padding: 0.75rem 1rem; }
      .app-title h1 { font-size: 0.95rem; }
      #date-label { min-width: 0; font-size: 0.8rem; order: 3; flex-basis: 100%; }
      #cards { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 400px) {
      #cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="app-bar">
    <div class="app-bar-inner">
      <div class="app-title">
        <span class="app-title-icon" aria-hidden="true">üèä</span>
        <h1>Swimfinder</h1>
      </div>
      <nav class="date-nav" aria-label="Navigate by date">
        <button class="btn btn-icon" id="btn-prev" aria-label="Previous day" title="Previous day">‚Üê</button>
        <span id="date-label" aria-live="polite" aria-atomic="true"></span>
        <button class="btn btn-icon" id="btn-next" aria-label="Next day" title="Next day">‚Üí</button>
        <button class="btn btn-text" id="btn-today">Today</button>
      </nav>
    </div>
  </header>

  <main class="main" id="main-content">
    <div id="now-bar" hidden role="status" aria-live="polite"></div>
    <div id="filter-bar" class="filter-bar" hidden role="group" aria-label="Filter by pool"></div>
    <div class="cal-wrap" id="cal-wrap" role="region" aria-label="Lane swimming schedule">
      <div class="loading">
        <div class="spinner" aria-hidden="true"></div>
        Loading schedules‚Ä¶
      </div>
    </div>
    <div id="cards"></div>
  </main>

  <script>
  (function () {
    var HOUR_START = 6;
    var HOUR_END   = 22;
    var HOUR_PX    = 60;
    var GUTTER_PX  = 46;
    var TOTAL_H    = (HOUR_END - HOUR_START) * HOUR_PX;

    var POOL_COLORS = ["#1d4ed8", "#7c3aed", "#0891b2", "#16a34a"];

    var currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);

    var filteredOut = {};
    var lastData    = null;

    /* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ */
    function isoDate(d) {
      return d.getFullYear() + "-" +
        String(d.getMonth() + 1).padStart(2, "0") + "-" +
        String(d.getDate()).padStart(2, "0");
    }

    function formatLabel(d) {
      return d.toLocaleDateString("en-GB", {
        weekday: "long", day: "numeric", month: "long", year: "numeric"
      });
    }

    function esc(s) {
      return String(s)
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function toMin(hhmm) {
      var p = hhmm.split(":");
      return parseInt(p[0], 10) * 60 + parseInt(p[1], 10);
    }

    function toPx(minutes) {
      return ((minutes - HOUR_START * 60) / 60) * HOUR_PX;
    }

    function badgeCls(src) {
      return "badge badge-" + (src === "live" || src === "fallback" ? src : "unavailable");
    }

    function badgeTxt(src) {
      return src === "live" ? "live" : src === "fallback" ? "fallback" : "unavailable";
    }

    function colorFor(idx) {
      return POOL_COLORS[idx % POOL_COLORS.length];
    }

    function isToday() {
      return isoDate(currentDate) === isoDate(new Date());
    }

    function fmtDur(startMin, endMin) {
      var m = endMin - startMin;
      if (m % 60 === 0) return (m / 60) + "h";
      if (m >= 60) return Math.floor(m / 60) + "h" + (m % 60) + "m";
      return m + "m";
    }

    /* ‚îÄ‚îÄ Now bar ‚îÄ‚îÄ */
    function buildNowBar(pools) {
      var bar = document.getElementById("now-bar");
      if (!isToday()) { bar.hidden = true; return; }

      var now    = new Date();
      var nowMin = now.getHours() * 60 + now.getMinutes();
      var active = [], upcoming = [];

      pools.forEach(function (pool, idx) {
        pool.slots.forEach(function (slot) {
          var s = toMin(slot.start), e = toMin(slot.end);
          if (nowMin >= s && nowMin < e) {
            active.push({ pool: pool, slot: slot, idx: idx });
          } else if (s > nowMin) {
            upcoming.push({ pool: pool, slot: slot, startMin: s, idx: idx });
          }
        });
      });
      upcoming.sort(function (a, b) { return a.startMin - b.startMin; });

      var html;
      if (active.length > 0) {
        bar.className = "now-bar now-bar-active";
        html = '<span class="now-dot" aria-hidden="true"></span>'
             + '<strong>Open for lane swimming:&nbsp;</strong>';
        html += active.map(function (a) {
          var c = colorFor(a.idx);
          return '<span class="now-pool-tag" style="color:' + c + '">' + esc(a.pool.name) + '</span>'
               + '<span class="now-until"> until ' + esc(a.slot.end) + '</span>';
        }).join('<span class="now-sep" aria-hidden="true">&nbsp;¬∑&nbsp;</span>');
      } else {
        bar.className = "now-bar now-bar-idle";
        html = '<span class="now-dot" aria-hidden="true"></span>'
             + '<strong>No lane swimming right now</strong>';
        if (upcoming.length > 0) {
          var nx = upcoming[0];
          var c  = colorFor(nx.idx);
          html += '<span class="now-sep" aria-hidden="true">&nbsp;¬∑&nbsp;</span>'
                + '<span class="now-next">Next: '
                + '<span style="color:' + c + ';font-weight:700">' + esc(nx.pool.name) + '</span>'
                + ' at ' + esc(nx.slot.start) + '</span>';
        }
      }
      bar.innerHTML = html;
      bar.hidden = false;
    }

    /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
    function buildFilterBar(pools) {
      var bar = document.getElementById("filter-bar");
      var html = '<span class="filter-label">Show:</span>';
      pools.forEach(function (pool, idx) {
        var c   = colorFor(idx);
        var off = filteredOut[pool.name] ? " off" : "";
        html += '<button class="filter-btn' + off + '"'
              + ' data-filter-pool="' + esc(pool.name) + '"'
              + ' style="border-color:' + c + ';color:' + c + '"'
              + ' aria-pressed="' + (filteredOut[pool.name] ? "false" : "true") + '">'
              + '<span class="swatch" style="background:' + c + '" aria-hidden="true"></span>'
              + esc(pool.name)
              + '</button>';
      });
      bar.innerHTML = html;
      bar.hidden = false;

      bar.querySelectorAll(".filter-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var name = btn.dataset.filterPool;
          if (filteredOut[name]) {
            delete filteredOut[name];
            btn.setAttribute("aria-pressed", "true");
          } else {
            filteredOut[name] = true;
            btn.setAttribute("aria-pressed", "false");
          }
          btn.classList.toggle("off");
          applyFilters();
        });
      });

      applyFilters();
    }

    function applyFilters() {
      document.querySelectorAll("[data-pool]").forEach(function (el) {
        el.style.display = filteredOut[el.dataset.pool] ? "none" : "";
      });
    }

    /* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
    function buildCalendar(pools) {
      // Header row
      var hdr = '<div class="cal-headers">'
        + '<div class="cal-gutter-head" style="width:' + GUTTER_PX + 'px"></div>';
      pools.forEach(function (pool, idx) {
        var c = colorFor(idx);
        hdr += '<div class="cal-col-head" data-pool="' + esc(pool.name) + '">'
             + '<a href="' + esc(pool.url) + '" target="_blank" rel="noopener" style="color:' + c + '">'
             + esc(pool.name) + '</a>'
             + '<span class="' + badgeCls(pool.source) + '">' + badgeTxt(pool.source) + '</span>'
             + '</div>';
      });
      hdr += '</div>';

      // Time gutter
      var gutter = '<div class="cal-time-col" style="width:' + GUTTER_PX + 'px;height:' + TOTAL_H + 'px">';
      for (var h = HOUR_START; h <= HOUR_END; h++) {
        var tp = toPx(h * 60);
        gutter += '<span class="cal-hour-label" style="top:' + tp + 'px">'
                + String(h).padStart(2, "0") + ':00</span>';
      }
      gutter += '</div>';

      // Pool columns
      var nowPx = null;
      var poolsDiv = '<div class="cal-pools" style="height:' + TOTAL_H + 'px">';
      pools.forEach(function (pool, idx) {
        var c   = colorFor(idx);
        var col = '<div class="cal-pool-col" data-pool="' + esc(pool.name) + '">';

        // Grid lines
        for (var h2 = HOUR_START; h2 <= HOUR_END; h2++) {
          var lp = toPx(h2 * 60);
          col += '<div class="cal-hline full" style="top:' + lp + 'px"></div>';
          if (h2 < HOUR_END) {
            col += '<div class="cal-hline half" style="top:' + (lp + HOUR_PX / 2) + 'px"></div>';
          }
        }

        // Swim slots
        pool.slots.forEach(function (slot) {
          var sMin   = toMin(slot.start);
          var eMin   = toMin(slot.end);
          var top    = toPx(sMin);
          var height = Math.max(((eMin - sMin) / 60) * HOUR_PX, 20);
          var dur    = fmtDur(sMin, eMin);
          var fb     = pool.source !== "live" ? " fallback" : "";
          var lbl    = esc(pool.name) + " " + esc(slot.start) + "‚Äì" + esc(slot.end);
          col += '<div class="cal-slot' + fb + '"'
               + ' style="top:' + top + 'px;height:' + height + 'px;background:' + c + '"'
               + ' title="' + lbl + '" aria-label="' + lbl + '">'
               + '<span class="sl-time">' + esc(slot.start) + '‚Äì' + esc(slot.end) + '</span>';
          if (height >= 34) {
            col += '<span class="sl-dur">' + dur + '</span>';
          }
          col += '</div>';
        });

        col += '</div>';
        poolsDiv += col;
      });

      // Current-time indicator (today only)
      if (isToday()) {
        var now = new Date();
        nowPx = toPx(now.getHours() * 60 + now.getMinutes());
        if (nowPx >= 0 && nowPx <= TOTAL_H) {
          poolsDiv += '<div class="cal-now" style="top:' + nowPx + 'px" aria-hidden="true"></div>';
        }
      }
      poolsDiv += '</div>';

      document.getElementById("cal-wrap").innerHTML =
        '<div class="cal-inner">'
        + hdr
        + '<div class="cal-body">' + gutter + poolsDiv + '</div>'
        + '</div>';

      // Scroll the now-line into view
      if (nowPx !== null) {
        var nowEl = document.querySelector(".cal-now");
        if (nowEl) {
          setTimeout(function () {
            nowEl.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 80);
        }
      }
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    function buildCards(pools) {
      var html = "";
      pools.forEach(function (pool, idx) {
        var c = colorFor(idx);
        var slotsHtml = pool.slots.length
          ? '<ul class="slots">' + pool.slots.map(function (s) {
              return '<li><span class="slot-dot" aria-hidden="true"></span>'
                   + esc(s.start) + " ‚Äì " + esc(s.end) + "</li>";
            }).join("") + "</ul>"
          : '<p class="no-slots">No lane swimming today</p>';

        html += '<div class="card" data-pool="' + esc(pool.name) + '" style="border-left-color:' + c + '">'
              + '<div class="card-header">'
              +   '<a href="' + esc(pool.url) + '" target="_blank" rel="noopener" style="color:' + c + '">' + esc(pool.name) + '</a>'
              +   '<span class="' + badgeCls(pool.source) + '">' + badgeTxt(pool.source) + '</span>'
              + '</div>'
              + slotsHtml
              + '</div>';
      });
      document.getElementById("cards").innerHTML = html;
    }

    /* ‚îÄ‚îÄ States ‚îÄ‚îÄ */
    function renderLoading() {
      document.getElementById("cal-wrap").innerHTML =
        '<div class="loading"><div class="spinner" aria-hidden="true"></div>Loading schedules‚Ä¶</div>';
      document.getElementById("cards").innerHTML = "";
      document.getElementById("now-bar").hidden = true;
      document.getElementById("filter-bar").hidden = true;
    }

    function renderError(msg) {
      document.getElementById("cal-wrap").innerHTML = '<p class="error">‚ö† ' + esc(msg) + '</p>';
      document.getElementById("cards").innerHTML = "";
      document.getElementById("now-bar").hidden = true;
    }

    /* ‚îÄ‚îÄ Load ‚îÄ‚îÄ */
    function loadSlots() {
      document.getElementById("date-label").textContent = formatLabel(currentDate);
      renderLoading();
      fetch("/api/slots?date=" + isoDate(currentDate))
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.error) { renderError(data.error); return; }
          lastData = data;
          buildNowBar(data.pools);
          buildFilterBar(data.pools);
          buildCalendar(data.pools);
          buildCards(data.pools);
          applyFilters();
        })
        .catch(function (err) { renderError(err.message || "Network error"); });
    }

    /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
    document.getElementById("btn-prev").addEventListener("click", function () {
      currentDate = new Date(currentDate.getTime() - 86400000);
      loadSlots();
    });
    document.getElementById("btn-today").addEventListener("click", function () {
      currentDate = new Date();
      currentDate.setHours(0, 0, 0, 0);
      loadSlots();
    });
    document.getElementById("btn-next").addEventListener("click", function () {
      currentDate = new Date(currentDate.getTime() + 86400000);
      loadSlots();
    });

    loadSlots();
  }());
  </script>
</body>
</html>
